<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - File Upload</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: #667eea;
        }

        .nav-links a {
            display: inline-block;
            padding: 10px 25px;
            background: #eee;
            color: #333;
            text-decoration: none;
            border-radius: 25px;
            margin: 5px;
        }

        .section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #e8eeff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8eeff;
            border-color: #4caf50;
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .format-help {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
            direction: ltr;
        }

        .format-help h3 {
            margin-bottom: 15px;
            color: #1976d2;
        }

        .format-help pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9em;
        }

        .preview-section {
            margin-top: 20px;
        }

        .question-preview {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-right: 5px solid #667eea;
        }

        .question-preview h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .options-preview {
            margin: 10px 0;
            padding-left: 20px;
        }

        .correct-answer {
            color: #4caf50;
            font-weight: bold;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #4caf50;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background: #eee;
            border: none;
            border-radius: 25px;
            cursor: pointer;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .lecture-item {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Admin Panel - File Upload</h1>
            <div class="nav-links">
                <a href="index.html">üè† Home Page</a>
            </div>
        </div>

        <div id="message-area"></div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('upload')">üì§ Upload File</button>
            <button class="tab" onclick="showTab('manual')">‚úçÔ∏è Manual Add</button>
            <button class="tab" onclick="showTab('lectures')">üìö Lectures</button>
        </div>

        <!-- Upload Tab -->
        <div id="upload" class="section">
            <h2>Upload Questions from File</h2>
            
            <div class="upload-area" onclick="document.getElementById('file-input').click()" 
                 ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                <div class="upload-icon">üìÑ</div>
                <h3>Click or Drag & Drop File Here</h3>
                <p>Supported: .txt, .doc, .docx</p>
                <input type="file" id="file-input" class="file-input" accept=".txt,.doc,.docx" onchange="handleFileSelect(event)">
            </div>

            <div class="format-help">
                <h3>üìã File Format:</h3>
                <pre>Question: Which vitamin is responsible for night vision?
A) Vitamin A
B) Vitamin B
C) Vitamin C
D) Vitamin D
Correct: A
Explanation: Vitamin A (Retinal) is responsible for night vision

Question: What is the function of Vitamin C?
A) Blood clotting
B) Collagen synthesis
C) Calcium absorption
D) Energy production
Correct: B
Explanation: Vitamin C is essential for collagen synthesis</pre>
            </div>

            <div id="preview-section" class="preview-section hidden">
                <h3>Preview (<span id="question-count">0</span> questions)</h3>
                <div id="questions-preview"></div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>Select Lecture:</label>
                    <select id="lecture-select">
                        <option value="">-- Select Lecture --</option>
                    </select>
                    <button class="btn btn-primary" onclick="showNewLectureInput()">+ New Lecture</button>
                </div>

                <div id="new-lecture-input" class="hidden" style="margin-top: 15px;">
                    <input type="text" id="new-lecture-name" placeholder="New lecture name">
                    <button class="btn btn-success" onclick="createNewLecture()">Create</button>
                </div>

                <div class="progress-bar hidden" id="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>

                <button class="btn btn-success" onclick="uploadAllQuestions()" id="upload-btn">
                    Upload All Questions
                </button>
            </div>
        </div>

        <!-- Manual Tab -->
        <div id="manual" class="section hidden">
            <h2>Add Lecture Manually</h2>
            <form id="lecture-form">
                <div class="form-group">
                    <label>Lecture Title</label>
                    <input type="text" id="lecture-title" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="lecture-desc"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Save Lecture</button>
            </form>
        </div>

        <!-- Lectures Tab -->
        <div id="lectures" class="section hidden">
            <h2>Existing Lectures</h2>
            <div id="lectures-list"></div>
        </div>
    </div>

    <script>
        // üî• FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDBiL71yGgcPtDPHodtVTm4Ab0BtJIEokA",
            authDomain: "quiz-app-95b33.firebaseapp.com",
            projectId: "quiz-app-95b33",
            storageBucket: "quiz-app-95b33.firebasestorage.app",
            messagingSenderId: "717714444581",
            appId: "1:717714444581:web:af0ea509f3bbe7d5f60acc",
            measurementId: "G-2RJE4KGZTE"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let parsedQuestions = [];
        let currentLectureId = null;

        window.onload = function() {
            loadLectures();
        };

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.remove('hidden');
        }

        function showMessage(msg, isError = false) {
            const area = document.getElementById('message-area');
            area.innerHTML = `<div class="${isError ? 'error-message' : 'success-message'}">${msg}</div>`;
            setTimeout(() => area.innerHTML = '', 5000);
        }

        // File Upload Functions
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) processFile(files[0]);
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        function processFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                parsedQuestions = parseQuestions(content);
                
                if (parsedQuestions.length === 0) {
                    showMessage('No questions found in file. Check format.', true);
                    return;
                }
                
                showPreview();
                showMessage(`Found ${parsedQuestions.length} questions!`);
            };
            
            reader.onerror = function() {
                showMessage('Error reading file', true);
            };
            
            reader.readAsText(file);
        }

        function parseQuestions(content) {
            const questions = [];
            const blocks = content.split(/\n\s*\n/); // Split by empty lines
            
            blocks.forEach(block => {
                const lines = block.trim().split('\n').map(l => l.trim()).filter(l => l);
                if (lines.length < 6) return;
                
                const questionMatch = lines[0].match(/^Question:\s*(.+)/i);
                if (!questionMatch) return;
                
                const question = questionMatch[1];
                
                // Parse options
                const options = [];
                for (let i = 1; i <= 4; i++) {
                    const optMatch = lines[i].match(/^[A-D]\)\s*(.+)/i);
                    if (optMatch) options.push(optMatch[1]);
                }
                
                if (options.length !== 4) return;
                
                // Parse correct answer
                const correctMatch = lines.find(l => l.match(/^Correct:\s*([A-D])/i));
                const correctLetter = correctMatch ? correctMatch.match(/^Correct:\s*([A-D])/i)[1].toUpperCase() : 'A';
                const correctAnswer = correctLetter.charCodeAt(0) - 65; // A=0, B=1, etc.
                
                // Parse explanation
                const expMatch = lines.find(l => l.match(/^Explanation:\s*(.+)/i));
                const explanation = expMatch ? expMatch.match(/^Explanation:\s*(.+)/i)[1] : '';
                
                questions.push({
                    question,
                    options,
                    correctAnswer,
                    explanation
                });
            });
            
            return questions;
        }

        function showPreview() {
            document.getElementById('preview-section').classList.remove('hidden');
            document.getElementById('question-count').textContent = parsedQuestions.length;
            
            const container = document.getElementById('questions-preview');
            container.innerHTML = '';
            
            parsedQuestions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'question-preview';
                div.innerHTML = `
                    <h4>Question ${i + 1}: ${q.question}</h4>
                    <div class="options-preview">
                        ${q.options.map((opt, idx) => `
                            <div class="${idx === q.correctAnswer ? 'correct-answer' : ''}">
                                ${String.fromCharCode(65 + idx)}) ${opt} ${idx === q.correctAnswer ? '‚úì' : ''}
                            </div>
                        `).join('')}
                    </div>
                    <p><strong>Explanation:</strong> ${q.explanation}</p>
                `;
                container.appendChild(div);
            });
        }

        function loadLectures() {
            db.collection('lectures').get().then(snapshot => {
                const select = document.getElementById('lecture-select');
                const list = document.getElementById('lectures-list');
                
                select.innerHTML = '<option value="">-- Select Lecture --</option>';
                list.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const lecture = doc.data();
                    
                    // Add to select
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = lecture.title;
                    select.appendChild(option);
                    
                    // Add to list
                    const div = document.createElement('div');
                    div.className = 'lecture-item';
                    div.innerHTML = `
                        <div>
                            <h3>${lecture.title}</h3>
                            <p>${lecture.questionCount || 0} questions</p>
                        </div>
                        <button class="btn btn-danger" onclick="deleteLecture('${doc.id}')">Delete</button>
                    `;
                    list.appendChild(div);
                });
            });
        }

        function showNewLectureInput() {
            document.getElementById('new-lecture-input').classList.remove('hidden');
        }

        function createNewLecture() {
            const name = document.getElementById('new-lecture-name').value.trim();
            if (!name) {
                showMessage('Please enter lecture name', true);
                return;
            }
            
            db.collection('lectures').add({
                title: name,
                description: '',
                questionCount: 0,
                createdAt: new Date()
            }).then(docRef => {
                currentLectureId = docRef.id;
                showMessage('Lecture created!');
                loadLectures();
                document.getElementById('new-lecture-input').classList.add('hidden');
                
                // Select the new lecture
                setTimeout(() => {
                    const select = document.getElementById('lecture-select');
                    select.value = currentLectureId;
                }, 500);
            });
        }

        document.getElementById('lecture-select').addEventListener('change', function() {
            currentLectureId = this.value;
        });

        function uploadAllQuestions() {
            if (!currentLectureId) {
                showMessage('Please select or create a lecture first', true);
                return;
            }
            
            if (parsedQuestions.length === 0) {
                showMessage('No questions to upload', true);
                return;
            }
            
            const progressBar = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');
            const uploadBtn = document.getElementById('upload-btn');
            
            progressBar.classList.remove('hidden');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';
            
            let uploaded = 0;
            const total = parsedQuestions.length;
            
            const uploadNext = (index) => {
                if (index >= total) {
                    showMessage(`Successfully uploaded ${total} questions!`);
                    progressBar.classList.add('hidden');
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'Upload All Questions';
                    
                    // Update question count
                    db.collection('lectures').doc(currentLectureId).update({
                        questionCount: firebase.firestore.FieldValue.increment(total)
                    });
                    
                    // Clear preview
                    setTimeout(() => {
                        document.getElementById('preview-section').classList.add('hidden');
                        parsedQuestions = [];
                        document.getElementById('file-input').value = '';
                    }, 2000);
                    
                    return;
                }
                
                const q = parsedQuestions[index];
                db.collection('lectures').doc(currentLectureId).collection('questions').add({
                    ...q,
                    order: index,
                    createdAt: new Date()
                }).then(() => {
                    uploaded++;
                    progressFill.style.width = `${(uploaded / total) * 100}%`;
                    uploadNext(index + 1);
                }).catch(err => {
                    console.error('Error uploading question:', err);
                    uploadNext(index + 1);
                });
            };
            
            uploadNext(0);
        }

        // Manual lecture form
        document.getElementById('lecture-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const title = document.getElementById('lecture-title').value;
            const desc = document.getElementById('lecture-desc').value;
            
            db.collection('lectures').add({
                title: title,
                description: desc,
                questionCount: 0,
                createdAt: new Date()
            }).then(() => {
                showMessage('Lecture added!');
                document.getElementById('lecture-form').reset();
                loadLectures();
            });
        });

        function deleteLecture(id) {
            if (!confirm('Delete this lecture and all its questions?')) return;
            
            // Delete questions first
            db.collection('lectures').doc(id).collection('questions').get()
                .then(snapshot => {
                    const batch = db.batch();
                    snapshot.forEach(doc => batch.delete(doc.ref));
                    return batch.commit();
                })
                .then(() => db.collection('lectures').doc(id).delete())
                .then(() => {
                    showMessage('Lecture deleted');
                    loadLectures();
                });
        }
    </script>
</body>
</html>